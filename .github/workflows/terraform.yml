name: Terraform S3 Deployment (Debug)

on:
  push:
    branches: [ "hal-feature-branch-modularize" ]
  pull_request:
    branches: [ "hal-feature-branch-modularize" ]

permissions:
  id-token: write
  contents: read

env:
  TF_LOG: DEBUG
  TF_LOG_PATH: terraform-debug.log
  AWS_REGION: us-east-1  

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    
    steps:

    # -----------------------
    # Checkout
    # -----------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------
    # Basic Debug Info
    # -----------------------
    - name: Print directory structure
      run: |
        echo "Current directory:"
        pwd
        echo "Repository contents:"
        ls -la
        echo "Terraform files:"
        find . -name "*.tf"

    # -----------------------
    # Setup Terraform
    # -----------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.6

    - name: Terraform Version
      run: terraform version

    # -----------------------
    # AWS Credentials
    # -----------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        role-session-name: github-terraform-session
        aws-region: us-east-1

    - name: Verify AWS Identity
      run: |
        aws sts get-caller-identity
        aws s3 ls || true

    # -----------------------
    # Terraform Init
    # -----------------------
    - name: Terraform Init
      run: terraform init -reconfigure

    # -----------------------
    # Terraform Validate
    # -----------------------
    - name: Terraform Validate
      run: terraform validate

    # -----------------------
    # Terraform Plan
    # -----------------------
    - name: Terraform Plan
      run: terraform plan -input=false -var="bucket_name=${{ secrets.BUCKET_NAME }}"

    # -----------------------
    # Terraform Apply (for hal-feature-branch-modularize)
    # -----------------------
    - name: Terraform Apply
      if: github.ref == 'refs/heads/hal-feature-branch-modularize' && github.event_name == 'push'
      run: terraform apply -auto-approve -input=false -var="bucket_name=${{ secrets.BUCKET_NAME }}"

    # -----------------------
    # Upload Debug Log
    # -----------------------
    - name: Upload Terraform Debug Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-debug-log
        path: terraform-debug.log
